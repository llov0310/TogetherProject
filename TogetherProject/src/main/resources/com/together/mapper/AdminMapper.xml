<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.together.mapper.AdminMapper">

	<!--  select시 셀렉트문  insert시 태그를 각자 맞는 sql문을 쓴다 -->
		
	<!-- 관리자 홈페이지 : "생년월일 + 숫자"를 가져오는 sql문 -->
	<select id="memberAge" resultType="com.together.domain.MemberVO">
	<![CDATA[
	with
	age as(
	select
	case
	when substr(birth_dt,7,7) = 1 or substr(birth_dt,7,7) = 2
	then to_number(to_char(sysdate, 'yyyy')) - to_number(concat('19', substr(birth_dt,1,2)))
	
	when substr(birth_dt,7,7) = 3 or substr(birth_dt,7,7) = 4
	then to_number(to_char(sysdate, 'yyyy')) - to_number(concat('20', substr(birth_dt,1,2)))
	
	end as result
	from member)

	select count(case when trunc(result/10,0)=1 then 1 else null end) as "age_10",
	    count(case when trunc(result/10,0)=2 then 1 else null end) as "age_20",
	    count(case when trunc(result/10,0)=3 then 1 else null end) as "age_30",
	    count(case when trunc(result/10,0)=4 then 1 else null end) as "age_40",
    	count(case when trunc(result/10,0)=5 then 1 else null end) as "age_50",
	    count(case when trunc(result/10,0)>=6 then 1 else null end) as "age_60_over"
    
	from age
	]]>
	</select>
	
	
	<!-- 관리자 홈페이지 : 총 회원수를 보여주는 sql문 -->
	<select id="memberCnt" resultType="int">
	<![CDATA[
	select count(*) 
	from member
	where user_id not in('admin')
	]]>
	</select>
	
	<!-- 관리자 홈페이지 : 업체 신청 수를 보여주는 sql문 -->
	<select id="etpApplyCnt" resultType="int">
	<![CDATA[
	select count(*)
	from member m, enterprise e
	where m.user_id = e.user_id and m.authority_no = 3
	]]>
	</select>
	
	<!-- 관리자 홈페이지 : 반려견 수를 보여주는 sql문 -->
	<select id="dogsCnt" resultType="int">
	<![CDATA[
	select count(*)
	from dogs
	]]>
	</select>
	
	<!-- 관리자 홈페이지 : 등록 된 업체 수를 보여주는 sql문 -->
	<select id="etpCnt" resultType="int">
	<![CDATA[
	select count(*)
	from member m, enterprise e
	where m.user_id = e.user_id and m.authority_no = 2
	]]>
	</select>
	
	
	<!-- 관리자 홈페이지 : 월 별 가입자 수를 보여주는 sql문 -->
	<select id="monthMemberCnt" resultType="com.together.domain.MemberVO">
	<![CDATA[
	select count(*) as count, to_char(register_dt, 'YYYY-MM') as month
	from member
	where register_dt like #{year}||'%'
	group by to_char(register_dt, 'YYYY-MM')
	order by month
	]]>
	</select>
	
	<!-- 업체 신청 관리 페이징을 위한 sql문 추가 -->
	<select id="enterpriseManage" resultType="com.together.domain.EnterpriseVO" parameterType="com.together.domain.Paging">
	<![CDATA[
	select x.rnum, x.*
	from(
    	select rownum as rnum, A.*
    	from(
        	select m.user_nm, m.authority_no, substr(e.etp_cd, 1,1) as etp_cd_substr, e.etp_email, e.user_id, e.etp_addr, e.etp_ph_no, e.etp_license_no, e.etp_nm, e.etp_content
        	from member m, enterprise e
        	where m.user_id = e.user_id and m.authority_no = 3
    	) A
    	where rownum < ${endNum}
	) x
	where x.rnum >= ${startNum}
	]]>
	</select>
	
	
	<!-- 반려견 페이징을 위한 sql문 추가 -->
	<select id="dogsList" resultType="com.together.domain.DogsVO" parameterType="com.together.domain.Paging">
	<![CDATA[
	select x.rnum, x.*
	from (
    	select rownum as rnum, A.*
        	from (select d.user_id, m.user_nm, m.ph_no, d.d_gender, d.d_dt, d.d_addr, d.d_kind, d.d_nm, d.d_content
            	from dogs d, member m where d.user_id = m.user_id
        	) A
            	where rownum < ${endNum}
	) x
	where x.rnum >= ${startNum}
	]]>
	</select>
	
	<!-- 관리자가 업체 신청 수락시 수행될 sql문 추가 -->
	<update id="etpApplyManage_01" parameterType="com.together.domain.MemberVO">
	update member
	set authority_no = 2
	where user_id = #{user_id}
	</update>
	
	<!-- 관리자가 업체 신청 거절시 수행될 sql문 추가 -->
	<delete id="etpApplyManage_02" parameterType="com.together.domain.EnterpriseVO">
	delete from enterprise
	where user_id = #{user_id}
	</delete>
	
	<!-- 회원관리 페이징을 위한 sql문 추가 -->
	<select id="memberList" resultType="com.together.domain.MemberVO" parameterType="com.together.domain.Paging">
	<![CDATA[
		select x.rnum, x.*
		from (select rownum as rnum, A.*
    	from (select * from member) A
    	where rownum < ${endNum}
		) x
		where x.rnum >= ${startNum}	
	]]>
	</select>
	
	<!-- 회원관리 페이지 넘버를 계산하기 위해 사용하는 sql문 -->
	<select id="memberPageNum" resultType="int">
		select count(*) from member
	</select>
	
	<!-- 반려견 관리 페이지 넘버를 계산하기 위해 사용하는 sql문 -->
	<select id="dogsPageNum" resultType="int">
		select count(*) from dogs
	</select>
	
	<!-- 업체 신청 관리 페이지 넘버를 계산하기 위해 사용하는 sql문 -->
	<select id="etpPageNum" resultType="int">
	<![CDATA[
	select count(*)
	from member m, enterprise e
	where m.user_id = e.user_id and m.authority_no = 3
	]]>
	</select>
	
	<!-- 회원관리 검색을 위해 사용하는 sql문 -->
	<select id="memberSearch" resultType="com.together.domain.MemberVO">
	<![CDATA[
	select * from member
	where ${searchType} like '%' || '${keyword}' || '%'
	order by user_nm		
	]]>
	</select>
	
	<select id="getSearchResult" resultType="com.together.domain.MemberVO" parameterType="map">
	<![CDATA[
	select x.rnum, x.*
	from (select rownum as rnum, before_ord.*
    	from (select * from member where ${Search.searchType}
    	like '%' || '${Search.keyword}' || '%' order by user_nm) before_ord
    		where rownum < #{Paging.endNum}) x
	where x.rnum >= #{Paging.startNum}
	order by x.user_nm
	]]>
	</select>
	
</mapper>